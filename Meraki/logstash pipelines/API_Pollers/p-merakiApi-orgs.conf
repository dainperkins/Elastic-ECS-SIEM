######################################################################################
#                                                                                  
#  Meraki API Device Poller                                                  
#                                                                                  
#  Last Revised:    03/05/2020
#  Transport:       HTTP Poller                                   
#  Compatibility:   ecs 1.5.0                                    
#  Notes:           Logstash pipeline to pull device information from Meraki API for 
#                   Enrichment Data
#                   MXs must have VLANs enabled for Subnet, DHCP, and lanIp
#                  
#                   GeoParsing is manual, based on address field in Meraki device:
#                     name;city_name;region_name;country_iso_code;region_iso_code;continent_name
#                     I'd recommend using internal "site codes" for names
#  To Do:           good schedule- run on new device? (webhook from Meraki)
#                   automate enrichment index build
#
#    !! WARNING !!   !! WARNING !!   !! WARNING !!   !! WARNING !!   !! WARNING !!  
#        If you enable VLANs on MX/W devices SSIDs will need to be reenabled!!!
######################################################################################

input {

    ##################################################################################
    # Start with Meraki Orgs
    ##################################################################################

    http_poller {
        urls => {
            meraki => {
                method => get
                url => "https://api.meraki.com/api/v0/organizations"
                headers => {
                    "X-Cisco-Meraki-API-Key" => "${meraki_api}"
                    Accept => "application/json"
                }
            }
        }
        request_timeout => 60
        schedule => { every => "1m" }
        codec => "json"
        metadata_target => "temp_org"
        target => "organization"
    }
    
}

filter {

    ## NOTE: iirc API keys are org specific, but if not uncomment
    ## the following split to allow for multiple organizations
    ## split { field => "organization" }

    ##################################################################################
    ### Get Meraki Network ids per organiaztion 
    ##################################################################################

    http {
        url => "https://n257.meraki.com/api/v0/organizations/%{[organization][id]}/networks"
        verb => "GET"
        headers => {
            "X-Cisco-Meraki-API-Key" => "${meraki_api}"
            Accept => "application/json" }
        target_body =>  "network" 
        target_headers => "temp_network"
    }

    split { field => "network" }

    ##################################################################################
    ### Get Meraki Device Information per network (org/network/device
    ##################################################################################

    http {
        url => "https://api.meraki.com/api/v0/networks/%{[network][id]}/devices"
        verb => "GET"
        headers => {
            "X-Cisco-Meraki-API-Key" => "${meraki_api}"
            Accept => "application/json" }
        target_body =>  "device" 
        target_headers => "temp_device"
    }

    split { field => "device" }

    ##################################################################################
    ### Get Meraki MX VLANs
    ##################################################################################

    if "MX" in [device][model] {
        http {
            url => "https://api.meraki.com/api/v0/networks/%{[network][id]}/vlans"
            verb => "GET"
            headers => {
                "X-Cisco-Meraki-API-Key" => "${meraki_api}"
                Accept => "application/json" }
            target_body =>  "vlan" 
            target_headers => "temp_vlan"
        }
        split { field => "vlan" }
        
        ## Fix LanIp for MX Series
        mutate {
            update => { "[device][lanIp]" => "%{[vlan][applianceIp]}" }
        }
    }
    

    ## Split up Firmware Information, skip offline devices

    if "Not" in [device][firmware] {
        mutate { remove_field => [ "[device][firmware]" ] }
    }
    else {
        mutate {
            add_field => { "firmware" => "%{[device][firmware]}" }
    
            split => { "firmware" => "-" }
            add_field => { "[os][family]" => "%{[firmware][0]}" }
            add_field => { "[os][version]" =>  "%{[firmware][1]}.%{[firmware][2]}" }    
            add_field => { "[os][full]" => "%{[firmware][0]} %{[firmware][1]}.%{[firmware][2]}" }
            rename => [ "[device][firmware]", "[meraki][device][firmware]" ]
        }
    }


    ## Internal address / geo Parsing based on Meraki Dashboard
    ######################################################################################
    ## name;city_name;region_name;country_iso_code;region_iso_code;continent_name

    grok {
        match => { "[device][address]" => "%{DATA:[geo][name]};%{DATA:[geo][city_name]};%{DATA:[geo][region_name]};%{WORD:[geo][country_iso_code]}-%{WORD:[geo][region_iso_code]};%{GREEDYDATA:[geo][continent_name]}" }
    }

    mutate {

        ## update region ISO code
        update => { "[geo][region_iso_code]" => "%{[geo][country_iso_code]}-%{[geo][region_iso_code]}" }

        remove_field => [ "[temp_org]", "[temp_network]", "[temp_device]", "[temp_vlan]" ]

        rename => [ "[organization]", "[meraki][organization]" ]
        rename => [ "[network]", "[meraki][network]" ]
        rename => [ "[device]", "[meraki][device]" ]

        add_field => { "[meraki][vlan][id]" => "%{[vlan][id]}" }
        add_field => { "[meraki][vlan][name]" => "%{[vlan][name]}" }
        add_field => { "[meraki][vlan][network_id]" => "%{[vlan][networkId]}" }
        add_field => { "[meraki][vlan][subnet]" => "%{[vlan][subnet]}" }

        remove_field => [ "[meraki][organization][@version]", "[meraki][organization][@timestamp]", "[meraki][organization][samlConsumerUrl]", "[meraki][organization][samlConsumerUrls]" ]
        remove_field => [ "[meraki][network][disableMyMerakiCom]", "[meraki][network][disableRemoteStatusPage]" ]
        remove_field => [ "[vlan]", "[meraki][device][networkId]", "[meraki][network][organizationId]" ]

        ## Add root level enrichment Fields for direct insertion
        add_field => { "name" => "%{[meraki][device][name]}" }
        add_field => { "mac" => "%{[meraki][device][mac]}" }
        add_field => { "product" => "%{[meraki][device][model]}" }
        add_field => { "serial_number" => "%{[meraki][device][serial]}" }

    }
}

output {
    elasticsearch {
        hosts => "${ES_HOST}"
        user => "${ES_INGEST}"
        password => "${ES_INGEST_PW}"
        index => "ecs-asset-meraki""
    }
}
######################################################################################
#                                                                                  
#  Meraki 802.1x Auth Logs Confgiguration  (AP & Switch Events)                                                
#                                                                                  
#  Last Revised:   04/11/2019 
#  Transport:      udp 9516                                  
#  Compatibility:  ecs 1.5.0 dev                                    
#  Notes:   gsub fix for meraki .s in names
#           updated to arrays for nested fields, added domain fixes  
######################################################################################

## discrete port for easy identification
input {
      udp {
      
        ## I've run into *nix configs that default to ipv6 and won't open an
        ## IPv4 port w/o hard coding, have yet to figure out why, so often hard 
        ## code IP the pipeline should listen on
        
        host => [logstash ip address]
        
        ## Update port for your environment, easiest way is to split Meraki
        ## Logs - URLs, events, etc to different ports. Configs coming
        ## soon for a single Meraki syslog target & multiple pipelines
        
        port  => 9516
    }
}

filter {
    ######################################################
    ###              Hash Original Message             ###
    ######################################################
    fingerprint {
        target => "[event][hash]"
    }

    ######################################################
    ###                Grok Meraki Auth                ###
    ######################################################

    grok {    
        match => { "message" => "<%{NUMBER:[syslog][facility]}>1 %{INT:millis}.%{INT:nanos} %{WORD:[host][name]} events type=%{NOTSPACE:eap_outcome} radio='%{NUMBER:[wireless][radio][id]}' vap='%{NUMBER:[wireless][ssid][id]}' client_mac='%{MAC:[source][mac]}' client_ip='%{IP:[source][ip]}' identity='%{EMAILADDRESS:[user][name]}' aid='%{NUMBER:[wireless][association][id]}'" }
    }
        
    ######################################################
    ###                  Add Auth fields               ###
    ######################################################
    if [eap_outcome] == "8021x_eap_success" {
        mutate {
            add_field => { "[event][type]" => "authentication_success" }
            add_field => { "[event][outcome]" => "success" }
        }
    }
    if [eap_outcome] == "8021x_eap_failure" {
        mutate {
            add_field => { "[event][type]" => "authentication_failure" }
            add_field => { "[event][outcome]" => "failure" }
        }
    }

    ######################################################
    ###         Fix for Nanosecond timestamps          ###
    ######################################################
    truncate {
            fields => "nanos"
            length_bytes => 3
    }

    mutate {

        ######################################################
        ###                Add core ECS fields             ###
        ######################################################
        add_field => { "[event][kind]" => "event" }
        add_field => { "[event][category]" => "authentication"}

        ##add_field => { "[event][action]" => "user_authentication"}

        add_field => { "[ecs][version]" => "1.5" }

        ######################################################
        ###             Populate host fields           ###
        ######################################################
        rename =>    { "[host]" => "[host][ip]"  }
        add_field => { "[host][type]" => "AP" }
        add_field => { "[host][os][name]" => "Meraki" }
        add_field => { "[host][os][platform]" => "Wireless" }
        add_field => { "[host][os][version]" => "25.13" }
        
        ## Fix Meraki _ reporting
        gsub => [ "[host][name]", "\_", "." ]

        rename =>    { "message" => "[event][original]" }

        ######################################################
        ###          Use event time for @timestamp         ###
        ######################################################
        add_field => { "[event][created]" => "%{@timestamp}" }
        #update => { "@timestamp" =>"%{millis}%{nanos}" }
    
        ##Clean Up
        remove_field => [ "millis", "nanos", "type" ]
    }
}


output {
        elasticsearch {
            hosts => "${ES_HOST}"
            user => "${ES_INGEST}"
            password => "${ES_INGEST_PW}"
            index => "ecs-meraki-auth-logs"
      }
}

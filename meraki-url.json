{
  "meraki-url" : {
    "description" : "Add geoip & ASN info, parse user agent for URL type logs",
    "version" : 1,
    "processors" : [
      {
        "geoip" : {
          "if" : "ctx.source?.geo == null",
          "field" : "client.ip",
          "target_field" : "client.geo",
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.geo == null",
          "field" : "source.ip",
          "target_field" : "source.geo",
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.geo == null",
          "field" : "destination.ip",
          "target_field" : "destination.geo",
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.geo == null",
          "field" : "server.ip",
          "target_field" : "server.geo",
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.geo == null",
          "field" : "host.ip",
          "target_field" : "host.geo",
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.as == null",
          "field" : "source.ip",
          "target_field" : "source.as",
          "properties" : [
            "asn",
            "organization_name"
          ],
          "ignore_missing" : true,
          "database_file" : "GeoLite2-ASN.mmdb"
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.as == null",
          "database_file" : "GeoLite2-ASN.mmdb",
          "field" : "destination.ip",
          "target_field" : "destination.as",
          "properties" : [
            "asn",
            "organization_name"
          ],
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.as == null",
          "database_file" : "GeoLite2-ASN.mmdb",
          "field" : "client.ip",
          "target_field" : "client.as",
          "properties" : [
            "asn",
            "organization_name"
          ],
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.as == null",
          "database_file" : "GeoLite2-ASN.mmdb",
          "field" : "server.ip",
          "target_field" : "server.as",
          "properties" : [
            "asn",
            "organization_name"
          ],
          "ignore_missing" : true
        }
      },
      {
        "geoip" : {
          "if" : "ctx.source?.as == null",
          "database_file" : "GeoLite2-ASN.mmdb",
          "field" : "host.ip",
          "target_field" : "host.as",
          "properties" : [
            "asn",
            "organization_name"
          ],
          "ignore_missing" : true
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "source.as.asn",
          "target_field" : "source.as.number"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "source.as.organization_name",
          "target_field" : "source.as.organization.name"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "destination.as.asn",
          "target_field" : "destination.as.number"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "destination.as.organization_name",
          "target_field" : "destination.as.organization.name"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "client.as.asn",
          "target_field" : "client.as.number"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "client.as.organization_name",
          "target_field" : "server.as.organization.name"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "server.as.asn",
          "target_field" : "server.as.number"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "server.as.organization_name",
          "target_field" : "server.as.organization.name"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "host.as.asn",
          "target_field" : "host.as.number"
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "host.as.organization_name",
          "target_field" : "host.as.organization.name"
        }
      },
      {
        "user_agent" : {
          "ignore_missing" : true,
          "field" : "useragent"
        }
      },
      {
        "remove" : {
          "ignore_missing" : true,
          "field" : "useragent"
        }
      }
    ],
    "on_failure" : [
      {
        "set" : {
          "field" : "error.message",
          "value" : "{{ _ingest.on_failure_message }}"
        }
      }
    ]
  }
}
